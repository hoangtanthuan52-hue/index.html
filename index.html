<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Study Streak Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes burn {
            0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.5)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 25px rgba(255, 69, 0, 0.8)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.5)); }
        }
        .flame-animate { animation: burn 2s infinite ease-in-out; transform-origin: center bottom; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .progress-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 select-none pb-24">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const STORAGE_KEY = 'study_streak_wisdom_v3'; // Gi·ªØ key c≈© ƒë·ªÉ kh√¥ng m·∫•t d·ªØ li·ªáu c·ªßa b·∫°n
        
        const QUOTES = [
            { text: "Thi√™n t√†i bao g·ªìm 1% c·∫£m h·ª©ng v√† 99% m·ªì h√¥i.", author: "Thomas Edison" },
            { text: "ƒê·ª´ng x·∫•u h·ªï khi kh√¥ng bi·∫øt, ch·ªâ x·∫•u h·ªï khi kh√¥ng h·ªçc.", author: "T·ª•c ng·ªØ Nga" },
            { text: "H·ªçc t·∫≠p l√† h·∫°t gi·ªëng c·ªßa ki·∫øn th·ª©c, ki·∫øn th·ª©c l√† h·∫°t gi·ªëng c·ªßa h·∫°nh ph√∫c.", author: "Ng·∫°n ng·ªØ Gruzia" },
            { text: "B·ªô r·ªÖ c·ªßa s·ª± h·ªçc th√¨ ƒë·∫Øng, nh∆∞ng qu·∫£ c·ªßa n√≥ th√¨ ng·ªçt.", author: "Aristotle" },
            { text: "ƒê·∫ßu t∆∞ v√†o tri th·ª©c mang l·∫°i l·ª£i nhu·∫≠n cao nh·∫•t.", author: "Benjamin Franklin" },
            { text: "T√¥i kh√¥ng th·∫•t b·∫°i. T√¥i ch·ªâ t√¨m ra 10.000 c√°ch kh√¥ng ho·∫°t ƒë·ªông.", author: "Thomas Edison" },
            { text: "C√°ch t·ªët nh·∫•t ƒë·ªÉ d·ª± ƒëo√°n t∆∞∆°ng lai l√† t·∫°o ra n√≥.", author: "Peter Drucker" },
            { text: "N·∫øu b·∫°n sinh ra trong ngh√®o kh√≥, ƒë√≥ kh√¥ng ph·∫£i l√† l·ªói c·ªßa b·∫°n. Nh∆∞ng n·∫øu b·∫°n ch·∫øt trong ngh√®o kh√≥, th√¨ ƒë√≥ l√† l·ªói c·ªßa b·∫°n.", author: "Bill Gates" },
            { text: "H√£y s·ªëng nh∆∞ th·ªÉ b·∫°n s·∫Ω ch·∫øt ng√†y mai. H√£y h·ªçc nh∆∞ th·ªÉ b·∫°n s·∫Ω s·ªëng m√£i m√£i.", author: "Mahatma Gandhi" },
            { text: "Kh√¥ng c√≥ √°p l·ª±c, kh√¥ng c√≥ kim c∆∞∆°ng.", author: "Thomas Carlyle" },
            { text: "Ng∆∞·ªùi ng·ªß d·∫≠y mu·ªôn kh√¥ng bao gi·ªù th·∫•y m·∫∑t tr·ªùi m·ªçc.", author: "T·ª•c ng·ªØ" },
            { text: "K·ª∑ lu·∫≠t l√† c·∫ßu n·ªëi gi·ªØa m·ª•c ti√™u v√† th√†nh t·ª±u.", author: "Jim Rohn" },
            { text: "Th√†nh c√¥ng kh√¥ng ph·∫£i l√† ƒë√≠ch ƒë·∫øn, ƒë√≥ l√† m·ªôt h√†nh tr√¨nh.", author: "Zig Ziglar" },
            { text: "ƒê·ª´ng ƒë·∫øm ng√†y th√°ng, h√£y l√†m cho ng√†y th√°ng tr·ªü n√™n ƒë√°ng t√≠nh.", author: "Muhammad Ali" },
            { text: "B·∫°n kh√¥ng c·∫ßn ph·∫£i tuy·ªát v·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu, nh∆∞ng b·∫°n ph·∫£i b·∫Øt ƒë·∫ßu ƒë·ªÉ tr·ªü n√™n tuy·ªát v·ªùi.", author: "Zig Ziglar" },
            { text: "S·ª± tr√¨ ho√£n l√† k·∫ª c·∫Øp th·ªùi gian.", author: "Edward Young" },
            { text: "H√†nh tr√¨nh ng√†n d·∫∑m b·∫Øt ƒë·∫ßu t·ª´ m·ªôt b∆∞·ªõc ch√¢n.", author: "L√£o T·ª≠" },
            { text: "Kh√≥ khƒÉn kh√¥ng tr∆∞·ªùng t·ªìn, ch·ªâ c√≥ con ng∆∞·ªùi b·∫£n lƒ©nh m·ªõi tr∆∞·ªùng t·ªìn.", author: "Robert Schuller" },
            { text: "ƒê·ª´ng gi·∫£m m·ª•c ti√™u, h√£y tƒÉng n·ªó l·ª±c.", author: "·∫®n danh" },
            { text: "Mu·ªën ƒëi nhanh h√£y ƒëi m·ªôt m√¨nh, mu·ªën ƒëi xa h√£y ƒëi c√πng nhau.", author: "T·ª•c ng·ªØ Ch√¢u Phi" },
            { text: "Th·∫•t b·∫°i ch·ªâ l√† c∆° h·ªôi ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i m·ªôt c√°ch th√¥ng minh h∆°n.", author: "Henry Ford" },
            { text: "N·∫øu b·∫°n kh√¥ng ch·ªãu thay ƒë·ªïi, b·∫°n s·∫Ω b·ªã ƒë√†o th·∫£i.", author: "Jack Ma" },
            { text: "Ng∆∞·ªùi duy nh·∫•t b·∫°n n√™n c·ªë g·∫Øng ƒë·ªÉ t·ªët h∆°n ch√≠nh l√† b·∫°n c·ªßa ng√†y h√¥m qua.", author: "Khuy·∫øt danh" },
            { text: "H√£y l√†m nh·ªØng vi·ªác kh√≥ khƒÉn khi ch√∫ng c√≤n d·ªÖ d√†ng.", author: "L√£o T·ª≠" },
            { text: "Th·ªùi gian t·ªët nh·∫•t ƒë·ªÉ tr·ªìng c√¢y l√† 20 nƒÉm tr∆∞·ªõc. Th·ªùi gian t·ªët th·ª© hai l√† ngay b√¢y gi·ªù.", author: "Ng·∫°n ng·ªØ Trung Hoa" },
            { text: "Kh√¥ng bao gi·ªù l√† qu√° mu·ªôn ƒë·ªÉ tr·ªü th√†nh ng∆∞·ªùi m√† b·∫°n l·∫Ω ra ƒë√£ tr·ªü th√†nh.", author: "George Eliot" },
            { text: "ƒê·ª´ng ch·ªù ƒë·ª£i. Th·ªùi gian s·∫Ω kh√¥ng bao gi·ªù l√† 'th√≠ch h·ª£p' c·∫£.", author: "Napoleon Hill" },
            { text: "N·∫øu b·∫°n mu·ªën c√≥ nh·ªØng th·ª© b·∫°n ch∆∞a t·ª´ng c√≥, b·∫°n ph·∫£i l√†m nh·ªØng vi·ªác b·∫°n ch∆∞a t·ª´ng l√†m.", author: "Thomas Jefferson" },
            { text: "Vinh quang l·ªõn nh·∫•t kh√¥ng ph·∫£i l√† kh√¥ng bao gi·ªù g·ª•c ng√£, m√† l√† ƒë·ª©ng d·∫≠y sau m·ªói l·∫ßn ng√£.", author: "Kh·ªïng T·ª≠" },
            { text: "Tr√≠ tu·ªá kh√¥ng ph·∫£i l√† s·∫£n ph·∫©m c·ªßa vi·ªác h·ªçc, m√† l√† n·ªó l·ª±c c·∫£ ƒë·ªùi ƒë·ªÉ c√≥ ƒë∆∞·ª£c n√≥.", author: "Albert Einstein" }
        ];

        const RANKS = [
            { name: "T·∫≠p S·ª±", minXP: 0, color: "text-slate-500", bg: "bg-slate-200", icon: "sprout" },
            { name: "M·ªçt S√°ch", minXP: 300, color: "text-green-500", bg: "bg-green-100", icon: "book" }, 
            { name: "H·ªçc Gi·∫£", minXP: 1200, color: "text-blue-500", bg: "bg-blue-100", icon: "graduation-cap" },
            { name: "Th·∫°c Sƒ©", minXP: 3000, color: "text-indigo-500", bg: "bg-indigo-100", icon: "award" },
            { name: "Gi√°o S∆∞", minXP: 6000, color: "text-purple-500", bg: "bg-purple-100", icon: "microscope" },
            { name: "Hi·ªÅn Tri·∫øt", minXP: 15000, color: "text-orange-500", bg: "bg-orange-100", icon: "scroll" },
            { name: "Th·∫ßn Tho·∫°i", minXP: 30000, color: "text-red-600", bg: "bg-red-100", icon: "crown" },
            { name: "V≈© Tr·ª•", minXP: 60000, color: "text-fuchsia-600", bg: "bg-fuchsia-100", icon: "infinity" },
        ];

        const MILESTONES = [
            { days: 1, label: "Kh·ªüi ƒë·∫ßu", icon: "footprints", color: "text-slate-500", bg: "bg-slate-100" },
            { days: 3, label: "Nhen nh√≥m", icon: "sparkles", color: "text-blue-400", bg: "bg-blue-50" },
            { days: 7, label: "1 Tu·∫ßn", icon: "star", color: "text-yellow-500", bg: "bg-yellow-100" },
            { days: 14, label: "2 Tu·∫ßn", icon: "shield", color: "text-indigo-500", bg: "bg-indigo-100" },
            { days: 21, label: "Th√≥i quen", icon: "target", color: "text-pink-500", bg: "bg-pink-100" },
            { days: 30, label: "1 Th√°ng", icon: "moon", color: "text-purple-500", bg: "bg-purple-100" },
            { days: 45, label: "Ki√™n ƒë·ªãnh", icon: "anchor", color: "text-cyan-600", bg: "bg-cyan-100" },
            { days: 60, label: "2 Th√°ng", icon: "flame", color: "text-orange-500", bg: "bg-orange-100" },
            { days: 90, label: "3 Th√°ng", icon: "zap", color: "text-yellow-600", bg: "bg-yellow-200" },
            { days: 100, label: "B√°ch Ph√°t", icon: "crown", color: "text-red-500", bg: "bg-red-100" },
            { days: 180, label: "6 Th√°ng", icon: "gem", color: "text-emerald-500", bg: "bg-emerald-100" },
            { days: 365, label: "1 NƒÉm", icon: "sun", color: "text-orange-500", bg: "bg-orange-200" },
            { days: 1000, label: "Th·∫ßn Th√°nh", icon: "infinity", color: "text-fuchsia-600", bg: "bg-fuchsia-200" },
        ];

        const TIMER_OPTIONS = [
            { label: "1p (Test)", value: 1 },
            { label: "15p", value: 15 },
            { label: "30p", value: 30 },
            { label: "45p", value: 45 },
            { label: "60p", value: 60 },
            { label: "1h 30p", value: 90 },
            { label: "3h", value: 180 },
        ];

        // --- Helpers ---
        const getTodayString = () => {
            const date = new Date();
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().split('T')[0];
        };
        const getYesterdayString = () => {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().split('T')[0];
        };
        const formatTime = (seconds) => {
            if (seconds < 0) return "00:00";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            if (h > 0) return `${h}:${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
            return `${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
        };

        const safeCopy = (text, onSuccess) => {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(onSuccess).catch(() => fallbackCopy(text, onSuccess));
            } else {
                fallbackCopy(text, onSuccess);
            }
        };

        const fallbackCopy = (text, onSuccess) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                onSuccess();
            } catch (err) {
                alert("Kh√¥ng th·ªÉ copy. H√£y ch·ª•p m√†n h√¨nh nh√©!");
            }
            document.body.removeChild(textArea);
        }

        function App() {
            // --- STATE INIT ---
            const [data, setData] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        let calcXP = parsed.totalXP || 0;
                        if (!parsed.totalXP && parsed.history) {
                            calcXP = Object.values(parsed.history).reduce((acc, curr) => acc + (curr.duration || 0), 0) / 60;
                        }
                        return {
                            currentStreak: parsed.currentStreak || 0,
                            lastCheckIn: parsed.lastCheckIn || null,
                            history: parsed.history || {},
                            bestStreak: parsed.bestStreak || 0,
                            activeSession: parsed.activeSession || null,
                            totalXP: Math.floor(calcXP)
                        };
                    }
                } catch (e) {}
                return { currentStreak: 0, lastCheckIn: null, history: {}, bestStreak: 0, activeSession: null, totalXP: 0 };
            });

            const [timeLeft, setTimeLeft] = useState(0);
            const [selectedDuration, setSelectedDuration] = useState(25);
            const [studyNote, setStudyNote] = useState("");
            const [showRankUp, setShowRankUp] = useState(null);
            const [showMilestoneAlert, setShowMilestoneAlert] = useState(null);
            const [copySuccess, setCopySuccess] = useState(false);
            const [dailyQuote, setDailyQuote] = useState(QUOTES[0]); 
            const timerRef = useRef(null);

            // --- QUOTE LOGIC ---
            useEffect(() => {
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 0);
                const diff = now - start;
                const oneDay = 1000 * 60 * 60 * 24;
                const dayOfYear = Math.floor(diff / oneDay);
                const quoteIndex = dayOfYear % QUOTES.length;
                setDailyQuote(QUOTES[quoteIndex]);
            }, []);

            // --- SAVE ---
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }, [data]);

            // --- TIMER ---
            useEffect(() => {
                const tick = () => {
                    if (data.activeSession) {
                        const now = Date.now();
                        const target = data.activeSession.targetTime;
                        const diff = Math.floor((target - now) / 1000);
                        setTimeLeft(diff > 0 ? diff : 0);
                    } else {
                        setTimeLeft(selectedDuration * 60);
                    }
                };
                tick();
                timerRef.current = setInterval(tick, 1000);
                return () => clearInterval(timerRef.current);
            }, [data.activeSession, selectedDuration]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const getCurrentRank = () => [...RANKS].reverse().find(r => data.totalXP >= r.minXP) || RANKS[0];
            const currentRank = getCurrentRank();
            const nextRankIndex = RANKS.findIndex(r => r.name === currentRank.name) + 1;
            const nextRank = RANKS[nextRankIndex] || null;
            const calculateProgress = () => {
                if (!nextRank) return 100;
                return Math.min(Math.max(((data.totalXP - currentRank.minXP) / (nextRank.minXP - currentRank.minXP)) * 100, 0), 100);
            };

            const isSessionActive = !!data.activeSession;
            const isTimerFinished = isSessionActive && timeLeft <= 0;

            const handleStart = () => {
                const durationSec = selectedDuration * 60;
                const now = Date.now();
                const target = now + (durationSec * 1000);
                setData(prev => ({ ...prev, activeSession: { targetTime: target, totalDuration: durationSec } }));
            };

            const handleCancel = () => {
                if (!confirm("H·ªßy b·ªè phi√™n h·ªçc? (Kh√¥ng t√≠nh XP)")) return;
                setData(prev => ({ ...prev, activeSession: null }));
            };

            const handleSubmit = () => {
                if (!studyNote.trim()) return;
                
                const today = getTodayString();
                const yesterday = getYesterdayString();
                let newStreak = data.currentStreak;
                let isStreakIncreased = false;
                
                if (data.lastCheckIn !== today) {
                    if (data.lastCheckIn === yesterday || newStreak === 0) {
                        newStreak += 1;
                        isStreakIncreased = true;
                    } else {
                        newStreak = 1; 
                        isStreakIncreased = true;
                    }
                }
                
                const sessionDurationMin = Math.floor((data.activeSession?.totalDuration || 0) / 60);
                const newTotalXP = (data.totalXP || 0) + sessionDurationMin;

                const oldRank = [...RANKS].reverse().find(r => data.totalXP >= r.minXP);
                const newRank = [...RANKS].reverse().find(r => newTotalXP >= r.minXP);
                if (newRank.minXP > oldRank.minXP) setShowRankUp(newRank);

                if (isStreakIncreased) {
                    const milestone = MILESTONES.find(m => m.days === newStreak);
                    if (milestone) setShowMilestoneAlert(milestone);
                }

                const prevHistory = data.history[today];
                const newHistoryItem = {
                    completed: true,
                    // Gi·ªØ nguy√™n d√≤ng n√†y ƒë·ªÉ n·ªëi note
                    note: prevHistory ? (prevHistory.note + "\n---\n" + studyNote) : studyNote,
                    duration: (prevHistory?.duration || 0) + (data.activeSession?.totalDuration || 0)
                };

                setData(prev => ({
                    ...prev,
                    currentStreak: newStreak,
                    bestStreak: Math.max(newStreak, data.bestStreak),
                    lastCheckIn: today,
                    history: { ...prev.history, [today]: newHistoryItem },
                    totalXP: newTotalXP,
                    activeSession: null
                }));

                setStudyNote("");
            };

            const shareStats = () => {
                const text = `üî• ƒêua kh√¥ng? T·ªõ ƒë√£ ƒë·∫°t c·∫•p "${currentRank.name}"!\n‚ö° Streak: ${data.currentStreak} ng√†y\nüìö T·ªïng: ${Math.floor(data.totalXP/60)}h ${data.totalXP%60}p.\n"${dailyQuote.text}"`;
                safeCopy(text, () => {
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                });
            };

            const hardReset = () => {
                if (confirm("Reset to√†n b·ªô d·ªØ li·ªáu?")) {
                    localStorage.removeItem(STORAGE_KEY);
                    window.location.reload();
                }
            };

            const renderCircle = () => {
                const r = 100;
                const c = 2 * Math.PI * r;
                const total = data.activeSession?.totalDuration || 1; 
                const progress = isSessionActive ? (timeLeft / total) : 1;
                const offset = c * (1 - progress);
                return (
                    <svg className="absolute w-full h-full transform -rotate-90 drop-shadow-xl">
                        <circle cx="128" cy="128" r={r} stroke="#f1f5f9" strokeWidth="12" fill="transparent" />
                        <circle cx="128" cy="128" r={r} stroke="currentColor" strokeWidth="12" fill="transparent"
                            strokeDasharray={c} strokeDashoffset={offset}
                            className={`text-indigo-600 transition-all duration-1000 linear ${!isSessionActive ? 'opacity-0' : ''}`}
                            strokeLinecap="round"
                        />
                    </svg>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans">
                    
                    {/* MODAL RANK UP */}
                    {showRankUp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-6 backdrop-blur-md animate-in fade-in">
                            <div className="bg-gradient-to-br from-indigo-900 to-purple-900 border border-indigo-500/50 p-8 rounded-3xl text-center w-full max-w-sm shadow-[0_0_50px_rgba(79,70,229,0.5)]">
                                <div className="text-yellow-400 text-sm font-bold uppercase tracking-widest mb-4">Level Up!</div>
                                <div className={`w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center ${showRankUp.bg} shadow-lg`}>
                                    <i data-lucide={showRankUp.icon} className={`w-12 h-12 ${showRankUp.color}`}></i>
                                </div>
                                <h2 className="text-3xl font-black text-white mb-2">{showRankUp.name}</h2>
                                <button onClick={() => setShowRankUp(null)} className="w-full py-3 bg-white text-indigo-900 font-bold rounded-xl mt-4">Ti·∫øp t·ª•c chi·∫øn</button>
                            </div>
                        </div>
                    )}

                    {/* MODAL MILESTONE */}
                    {showMilestoneAlert && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-6 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-slate-900 border border-slate-700 p-8 rounded-3xl text-center w-full max-w-sm">
                                <div className={`w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center ${showMilestoneAlert.bg}`}>
                                    <i data-lucide={showMilestoneAlert.icon} className={`w-10 h-10 ${showMilestoneAlert.color}`}></i>
                                </div>
                                <h2 className="text-3xl font-black text-white mb-2">M·ªëc Streak!</h2>
                                <p className="text-slate-400 mb-6">ƒê√£ ƒë·∫°t <span className="text-orange-400 font-bold">{showMilestoneAlert.label}</span></p>
                                <button onClick={() => setShowMilestoneAlert(null)} className="w-full py-3 bg-orange-600 text-white font-bold rounded-xl">Tuy·ªát v·ªùi</button>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <div className="bg-white/80 backdrop-blur sticky top-0 z-20 px-4 py-3 flex justify-between items-center border-b border-slate-200">
                        <div className="flex items-center gap-2">
                            <div className="bg-indigo-600 p-1.5 rounded-lg"><i data-lucide="gem" className="w-5 h-5 text-white"></i></div>
                            <span className="font-bold text-lg text-slate-800">Wisdom App</span>
                        </div>
                        <div onClick={hardReset} className="text-[10px] text-slate-400 p-2 cursor-pointer border border-slate-200 rounded hover:bg-red-50 hover:text-red-500">RESET</div>
                    </div>

                    <div className="px-4 py-6 space-y-6 max-w-md mx-auto">
                        
                        {/* 0. DAILY QUOTE */}
                        <div className="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-2xl border border-amber-100 flex gap-3 items-start shadow-sm">
                            <div className="mt-1 text-amber-500 min-w-[20px]"><i data-lucide="quote" className="w-5 h-5 fill-amber-500"></i></div>
                            <div>
                                <p className="text-sm text-slate-700 font-medium italic leading-relaxed">"{dailyQuote.text}"</p>
                                <p className="text-xs text-slate-400 font-bold mt-1 text-right">- {dailyQuote.author}</p>
                            </div>
                        </div>

                        {/* 1. RANK CARD */}
                        <div className="bg-white rounded-[2rem] p-6 shadow-xl border border-slate-100 relative overflow-hidden">
                            <div className="flex justify-between items-start mb-4 relative z-10">
                                <div>
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">C·∫•p b·∫≠c hi·ªán t·∫°i</p>
                                    <h2 className={`text-3xl font-black ${currentRank.color}`}>{currentRank.name}</h2>
                                </div>
                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${currentRank.bg}`}>
                                    <i data-lucide={currentRank.icon} className={`w-6 h-6 ${currentRank.color}`}></i>
                                </div>
                            </div>
                            <div className="relative z-10">
                                <div className="flex justify-between text-xs font-bold text-slate-500 mb-1.5">
                                    <span>XP: {data.totalXP}p</span>
                                    <span>{nextRank ? `Next: ${nextRank.minXP}` : "Max"}</span>
                                </div>
                                <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div className={`h-full bg-gradient-to-r from-blue-400 to-indigo-600 progress-bar`} style={{width: `${calculateProgress()}%`}}></div>
                                </div>
                            </div>
                            <div className={`absolute -bottom-10 -right-10 w-40 h-40 ${currentRank.bg} rounded-full blur-3xl opacity-50`}></div>
                        </div>

                        {/* 2. STREAK STATS */}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-slate-900 rounded-2xl p-4 text-white text-center shadow-lg relative overflow-hidden">
                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-orange-600 rounded-full blur-[40px] opacity-40"></div>
                                <i data-lucide="flame" className="w-8 h-8 mx-auto mb-2 text-orange-500 fill-orange-500 relative z-10"></i>
                                <div className="text-3xl font-black relative z-10">{data.currentStreak}</div>
                                <div className="text-[10px] text-slate-400 uppercase font-bold relative z-10">Ng√†y Streak</div>
                            </div>
                            <div className={`rounded-2xl p-4 text-center border shadow-sm flex flex-col justify-center items-center cursor-pointer transition-all active:scale-95 ${copySuccess ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100 hover:bg-indigo-50'}`} onClick={shareStats}>
                                <i data-lucide={copySuccess ? "check" : "share-2"} className={`w-6 h-6 mb-2 ${copySuccess ? 'text-green-600' : 'text-indigo-600'}`}></i>
                                <div className={`text-sm font-bold ${copySuccess ? 'text-green-700' : 'text-slate-700'}`}>{copySuccess ? "ƒê√£ Copy!" : "Khoe B·∫°n B√®"}</div>
                                <div className="text-[10px] text-slate-400 mt-1">{copySuccess ? "D√°n v√†o tin nh·∫Øn" : "B·∫•m ƒë·ªÉ copy"}</div>
                            </div>
                        </div>

                        {/* 3. MILESTONES SCROLL */}
                         <div className="space-y-2">
                             <div className="text-xs font-bold text-slate-400 uppercase tracking-wider px-1">Chinh ph·ª•c m·ªëc Streak</div>
                             <div className="flex gap-3 overflow-x-auto pb-4 pt-1 no-scrollbar px-1">
                                {MILESTONES.map(m => {
                                    const unlocked = data.currentStreak >= m.days;
                                    return (
                                        <div key={m.days} className="flex-shrink-0 flex flex-col items-center gap-1 opacity-90">
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center border-2 transition-all ${unlocked ? `${m.bg} ${m.color} border-transparent shadow-md scale-105` : 'bg-white border-slate-200 text-slate-300'}`}>
                                                <i data-lucide={m.icon} className="w-5 h-5"></i>
                                            </div>
                                            <span className={`text-[10px] font-bold ${unlocked ? 'text-slate-700' : 'text-slate-400'}`}>{m.days}d</span>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>

                        {/* 4. MAIN INTERACTION */}
                        <div className="bg-white rounded-[2rem] shadow-xl border border-slate-100 overflow-hidden min-h-[320px]">
                            {isTimerFinished ? (
                                <div className="p-8 flex flex-col justify-center h-full fade-in bg-green-50/30">
                                    <div className="text-center mb-6">
                                        <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 animate-bounce">
                                            <i data-lucide="check" className="w-8 h-8"></i>
                                        </div>
                                        <h3 className="text-2xl font-black text-slate-800">Xu·∫•t s·∫Øc!</h3>
                                        <p className="text-slate-500 text-sm">B·∫°n v·ª´a ki·∫øm th√™m <span className="font-bold text-indigo-600">+{Math.floor((data.activeSession?.totalDuration||0)/60)} XP</span></p>
                                    </div>
                                    <textarea 
                                        className="w-full p-4 bg-white border-2 border-slate-200 rounded-2xl mb-4 focus:border-green-500 focus:outline-none focus:ring-4 focus:ring-green-500/20 transition-all text-base min-h-[120px]" 
                                        rows="4" 
                                        placeholder="T·ªïng k·∫øt nhanh..." 
                                        value={studyNote}
                                        onChange={e => setStudyNote(e.target.value)}
                                    ></textarea>
                                    <button onClick={handleSubmit} disabled={!studyNote.trim()} className="w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-2xl shadow-lg disabled:opacity-50 transition-all active:scale-95">
                                        Nh·∫≠n XP & Streak
                                    </button>
                                </div>
                            ) : (
                                <div className="p-6 flex flex-col items-center">
                                    {isSessionActive && <div className="absolute top-4 right-4 bg-red-100 text-red-500 text-[10px] font-bold px-2 py-1 rounded-full animate-pulse">LIVE</div>}
                                    
                                    <div className="relative w-64 h-64 flex items-center justify-center mb-6 mt-2">
                                        {renderCircle()}
                                        <div className="flex flex-col items-center relative z-10 bg-white w-44 h-44 rounded-full justify-center shadow-[inset_0_2px_10px_rgba(0,0,0,0.05)] border border-slate-50">
                                            <span className="text-5xl font-mono font-bold text-slate-700 tracking-tighter">{formatTime(timeLeft)}</span>
                                            <p className="text-xs text-slate-400 mt-1 font-medium bg-slate-100 px-2 py-0.5 rounded">
                                                {isSessionActive ? "ƒêang t·∫≠p trung" : "Ph√∫t"}
                                            </p>
                                        </div>
                                    </div>

                                    {!isSessionActive ? (
                                        <div className="w-full space-y-4">
                                            <div className="grid grid-cols-4 gap-2">
                                                {TIMER_OPTIONS.map(opt => (
                                                    <button key={opt.value} onClick={()=>{setSelectedDuration(opt.value); setTimeLeft(opt.value*60)}} className={`py-2 px-1 rounded-xl text-xs font-bold border transition-all ${selectedDuration===opt.value ? 'bg-slate-800 text-white border-slate-800' : 'bg-slate-50 text-slate-500 border-transparent'}`}>
                                                        {opt.label}
                                                    </button>
                                                ))}
                                            </div>
                                            <button onClick={handleStart} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200 text-lg transition-transform active:scale-95 flex items-center justify-center gap-2">
                                                <i data-lucide="play" className="w-5 h-5 fill-current"></i> B·∫Øt ƒë·∫ßu
                                            </button>
                                        </div>
                                    ) : (
                                        <button onClick={handleCancel} className="text-slate-400 text-sm font-semibold bg-slate-50 hover:bg-red-50 hover:text-red-500 px-8 py-3 rounded-xl border border-slate-200 transition-colors">
                                            H·ªßy b·ªè (M·∫•t XP)
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* 5. HISTORY (FIXED WRAPPING) */}
                        <div className="pt-2 pb-10">
                            <div className="flex items-center gap-2 mb-3 px-1">
                                <i data-lucide="history" className="w-4 h-4 text-slate-400"></i>
                                <span className="text-sm font-bold text-slate-500 uppercase tracking-wide">Nh·∫≠t k√Ω</span>
                             </div>
                            {Object.entries(data.history).length > 0 ? (
                                <div className="space-y-3">
                                    {Object.entries(data.history)
                                        .sort((a,b) => b[0].localeCompare(a[0]))
                                        .slice(0, 5)
                                        .map(([date, info]) => (
                                        <div key={date} className="bg-white p-3 rounded-xl border border-slate-100 flex gap-3 items-start opacity-90 hover:opacity-100 transition-opacity">
                                            <div className="bg-slate-100 px-3 py-1 rounded-lg text-center min-w-[3.5rem] mt-1">
                                                <div className="text-[10px] text-slate-400 font-bold uppercase">{new Date(date).getDate()}/{new Date(date).getMonth()+1}</div>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-full">DONE</span>
                                                </div>
                                                {/* FIX: break-words whitespace-pre-wrap cho ph√©p xu·ªëng d√≤ng */}
                                                <p className="text-sm text-slate-700 font-medium break-words whitespace-pre-wrap leading-snug">
                                                    {info.note}
                                                </p>
                                                <div className="text-xs text-slate-400 mt-1">+{Math.floor((info.duration||0)/60)} XP</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center text-slate-400 text-xs py-4">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

